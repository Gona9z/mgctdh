<!DOCTYPE html>
<html lang="en">
<head>
    <title>{$pro_name}台管理系统</title>
    <link rel="stylesheet" href="__PUBLIC__/assets/css/share.css" /><!--另添加样式文件-->
    <include  file="Public/assets/common/header.html"/><!--头部文件-->
    <link href="__PUBLIC__/assets/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
    <!--讨论区滚动条begin-->
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/assets/css/jscrollpane1.css" />
    <!--上传文件-->
    <link href="__PUBLIC__/assets/plugins/bootstrap-fileinput/css/fileinput.css" media="all" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="__PUBLIC__/back_css/edit_common.css">

    <script src="__PUBLIC__/back_js/jquery-form.js"></script>
    <style>
        #goods_text{margin: 10px 0 0 10px;}
        .goods_e{padding: 10px;}
        #commodity_main input[type=file]{margin-top: 100px;}
        #commodity_main img{width: 240px;height: 288px;}
        #commodity_main textarea{min-height: 80px;width: 60%;}
        #commodity_main td span{line-height: 100px;}
        #commodity_main, #information, #specifications, #attribute{margin:10px 0;}
        #commodity_main input{height: 35px;}
        #commodity_main .edit_goods select{width: 70px;}
        #goods_body tr td{text-align: center;}
        #goods_edit_id{width: 70px!important;}
        #commodity_main .edit_goods a{margin-left: 10px;}
        #input_point{width: 20px;margin: 0 10px;border-color: #ddd;}
        #commodity_main .class_b_b .class_list{
            position: relative ;
            float: left;
            margin:0;
            padding:4px;
            /*border:1px solid #999;*/
        }
        #commodity_main .class_b_b .class_list i{
            width:10px;
            height:10px;
            -webkit-border-radius:50%;
            -moz-border-radius:50%;
            border-radius:50%;
            background: #2b7dbc;
            z-index: 100;
            float: left;
            margin-left:-14px;
            margin-top:8px;
        }
        #commodity_main .class_list p{
            position: absolute;
            background: rgba(0,0,0,0.3);
        }
        #commodity_main .class_list p label{
            border:none;
            background: none;
            color: #fff;
            width:auto;
            width: 40px;
            padding: 3px 0 0 8px;
        }
    </style>
</head>

<body>
<include  file="Public/assets/common/top.html"/>
<div class="main-container" id="main-container">
    <include  file="Public/assets/common/nav.html"/><!--左侧导航栏-->
    <div class="main-content">
        <div class="breadcrumbs" id="breadcrumbs">
            <ul class="breadcrumb">
                <li>
                    <i class="icon-home home-icon"></i>
                    <a href="#">首页</a>
                </li>
                <li class="active">搭配管理</li>
                <li class="active">搭配列表</li>
                <li class="active">编辑搭配商品</li>
            </ul><!-- .breadcrumb -->
        </div>

        <div id="commodity_details">
            <h1><img src="__PUBLIC__/back_img/ico.png">修改搭配商品
                <a href="javascript:history.go(-1);"><span><img src="__PUBLIC__/back_img/return.png"></span></a></h1>
            <div id="commodity_list">
                <!--通用信息_开始-->
                <form action="__ACTION__" method="post" id="edit_form" enctype="multipart/form-data" >

                    <div id="commodity_main" class="clear">
                        <table>
                            <input type="hidden" value="{$collocation['collocation_id']}" name="id">
                            <tr class="class_b_b">
                                <th>搭配图片：</th>
                                <td>
                                    <div class="class_list">
                                        <img src="__APP__{$collocation.image}">
                                    </div>
                                </td>
                            </tr>
                            <tr class="edit_goods">
                                <th>商品编辑：</th>
                                <td class="goods_e">
                                    <select name="goods_edit" id="goods_edit_select">
                                    </select>
                                    商品ID:<input type="text" id="goods_edit_id">
                                    文本:<input type="text" id="goods_edit_text" value="2">
                                    <a href="javaScript:void(0);" class='btn btn-sm btn-primary' onclick="addGoodsNode();">添加</a>
                                    <div id="goods_text">暂无商品</div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>序号</th>
                            <th>商品</th>
                            <th>文本内容</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="goods_body">
                        <foreach name="node_list" item="l" key="k">
                            <tr id="line_{$k}">
                                <td>
                                    <input type="hidden" name="index_x[]" value="{$l.index_x}"/>
                                    <input type="hidden" name="index_y[]" value="{$l.index_y}"/>
                                    <input type="hidden" name="goods_id[]" value="{$l.goods_id}"/>
                                    点<input type="text" value="{$k+1}" disabled="disabled" id="input_point" name="err[]"/>
                                </td>
                                <td>{$l.name}</td>
                                <td><input type="text" value="{$l.goods_text}" name="goods_text[]"/></td>
                                <td class="operation">
                                    <a href="javaScript:void(0);" onclick="delNode('{$k}');">删除</a>
                                </td>
                            </tr>
                        </foreach>
                        </tbody>
                    </table>

                    <input id="li1_btn" type="button" value="保存"/>
                </form>
                <!--通用信息_结束-->
            </div>
        </div>
    </div><!-- /.main-content -->
</div><!--main-container-->

<include  file="Public/assets/common/footer.html"/>

</body>

<script>
    $(".dpgl").addClass("active open");
    $(".dpgl .dplb").addClass("active");
    var MODULE = "__MODULE__";
    $('#li1_btn').click(function(){
//        $msg = $('#edit_form').serialize();
//        console.log($msg);
//        return;
        $('#edit_form').ajaxSubmit({
            url:"__ACTION__",
            dataType: "json",
            beforeSend: function() {
                $('#li1_btn').attr('disabled','true');
                $('#li1_btn').attr('value','上传中...');
            },
            type: "post",
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success : function(data){
                alert(data.msg);
                if(0==data.errorCode){
                    location.href = document.referrer;
                }else{
                    $('#li1_btn').removeAttr('disabled');
                    $('#li1_btn').attr('value','保存');
                }
            }
        });
    });

    $(function(){
        var id = "{$Think.get.id}";
        $.post(MODULE+'/Collocation/getCGoodsNode',{'id':id},function(data){
            var node_list = data.data;
            $.each(node_list,function(k,v){
                addNode(this.index_x*240,this.index_y*288,120);
                console.log(this.index_x);
            });
        });
    });


    var xx;
    var yy;
    var num = 0;
    $('.class_b_b img').click(function(e){
        var imgWidth = $(this).width()/2;
        xx = e.pageX - $(this).offset().left;
        yy = e.pageY - $(this).offset().top;
        addNode(xx,yy,imgWidth);
    });

    //添加节点
    function addNode(xx,yy,imgWidth){
        var x2 = xx;
        var finalWidth = imgWidth - 40;
        $('.class_b_b .class_list').append(
//                '<p class="num'+num+'"><i></i><input type="text" autofocus="autofocus" placeholder="请输入标签"></p>'
                '<p class="num'+num+'"><i></i><label>点'+(num+1)+'</label></p>'
        );
        $('#goods_edit_select').append(
                '<option value="'+(num+1)+'" data_x="'+xx+'" data_y="'+yy+'">点'+(num+1)+'</option>');
        /*$('.class_b_b .class_list p:eq('+num+')').css({
         'left':xx,
         'top': yy
         });*/

        if(xx > imgWidth){
            x2 = imgWidth*2 - xx;
            if(x2 <40){
//                $('.class_b_b .class_list p:eq('+num+')').css({
//                    'right':0,
//                    'top': yy
//                });
                $('.class_b_b .class_list .num'+num+'').css({
                    'right':0,
                    'top': yy
                });
            }else{
//                $('.class_b_b .class_list p:eq('+num+')').css({
//                    'left':xx+20,
//                    'top': yy
//                });
                $('.class_b_b .class_list .num'+num+'').css({
                    'left':xx+20,
                    'top': yy
                });
            }
        }else{
//            $('.class_b_b .class_list p:eq('+num+') i').css({
//                'float':'right',
//                'margin-right':'-14px'
//            });
            $('.class_b_b .class_list .num'+num+' i').css({
                'float':'right',
                'margin-right':'-14px'
            });
            if(xx < 40){
//                $('.class_b_b .class_list p:eq('+num+')').css({
//                    'left':0,
//                    'top': yy
//                });
                $('.class_b_b .class_list .num'+num+'').css({
                    'left':0,
                    'top': yy
                });
            }else{
//                $('.class_b_b .class_list p:eq('+num+')').css({
//                    'left':xx-40,
//                    'top': yy
//                });
                $('.class_b_b .class_list .num'+num+'').css({
                    'left':xx-40,
                    'top': yy
                });
            }
        }
        num++;
    }

    //删除节点
    function delNode(num){
        $('.num'+num).remove();
        $('#line_'+num).remove();
    }

    var goods;
    var goods_id;
    document.getElementById('goods_edit_id').oninput=function(){
        goods_id = $(this).val();
        $.post(MODULE+'/Goods/getGoods',{'id':goods_id},function(data){
            var data = data.data;
            if(null!==data){
                goods = data;
                $('#goods_text').html('(ID:'+data.goods_id+','+data.name+')')
            }else{
                goods = null;
                $('#goods_text').html('');
            }
        });
    }
    function addGoodsNode() {
        var dian = $('#goods_edit_select').val();
        if(null==dian){
            alert('请先在图片上选择坐标');
        }else{
            if(null==goods){
                alert('请输入商品ID');
            }else{
                var goods_text = $('#goods_edit_text').val();
                if(null==goods_text||''==goods_text){
                    alert('请输入商品文本介绍');
                }else{
                    var str = '<tr><td><input type="hidden" name="index_x[]" value="'+xx+'"/>';
                    str += '<input type="hidden" name="index_y[]" value="'+yy+'"/>';
                    str += '<input type="hidden" name="goods_id[]" value="'+goods_id+'"/>';
                    str += '点<input type="text" value="'+dian+'" disabled="disabled" id="input_point" name="err[]"/></td>';
                    str += '<td>'+goods.name+'</td><td><input type="text" value="'+goods_text+'" name="goods_text[]"/></td>';
                    str += '<td class="operation"><a href="javaScript:void(0);" onclick="">删除</a></td></tr>';
                    $('#goods_body').append(str);
                }
            }
        }
    }



</script>
</html>
